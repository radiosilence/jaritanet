name: üèóÔ∏è Run Ansible Playbook

permissions:
  contents: read
  packages: write
  actions: write

on:
  push:
    branches:
      - main
    paths:
      - "ansible/**"
      - ".github/workflows/run-playbook.yml"

concurrency:
  group: "ansible"

jobs:
  playbook:
    name: üöÄ Deploy Configuration
    runs-on: ubuntu-24.04
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v2
      - name: üõ†Ô∏è Setup Development Environment
        uses: jdx/mise-action@v2
      - name: üîå Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh/
          chmod 700 ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          sudo chmod 600 ~/.ssh/*
      - name: üîç Verify Host Connectivity
        run: |
          echo "Checking DNS resolution..."
          nslookup oldboy.zonkey-jazz.ts.net
          echo "Testing connectivity..."
          ping -c 3 oldboy.zonkey-jazz.ts.net
      - name: üèóÔ∏è Execute Ansible Playbook
        uses: dawidd6/action-ansible-playbook@v4
        with:
          playbook: playbook.yml
          directory: ./ansible
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          options: |
            --limit homeservers
            --verbose
        env:
          SAMBA_PASSWORD: ${{ secrets.SAMBA_PASSWORD }}
          GIT_SSH_KEY: ${{ secrets.GIT_SSH_KEY }}
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}

      - name: üîê Update GitHub Secrets
        run: ./scripts/update-secrets
        env:
          GITHUB_TOKEN: ${{ secrets.SECRETS_PAT }}
