name: CI/CD

permissions:
  contents: read

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - .github/workflows/ci-cd.yml
      - "packages/**"
      - "*.config.*"
      - package.json
  pull_request:
    paths:
      - .github/workflows/ci-cd.yml
      - "packages/**"
      - "*.config.*"
      - package.json
  workflow_call:
    secrets:
      PULUMI_ACCESS_TOKEN:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true
      TS_OAUTH_CLIENT_ID:
        required: true
      TS_OAUTH_SECRET:
        required: true
      KUBE_HOST:
        required: true
      KUBE_API_PORT:
        required: true
      KUBE_TOKEN:
        required: true
      NAVIDROME_HOSTNAME:
        required: true
      FILES_HOSTNAME:
        required: true
      BLIT_HOSTNAME:
        required: true
      CLOUDFLARE_ACCOUNT_ID:
        required: true

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: jdx/mise-action@v2

      - name: Install Dependencies
        run: bun install

      - name: Type Check
        run: |
          npm run typecheck:infra
          npm run typecheck:k8s
          npm run typecheck:routes

      - name: Run Tests
        run: npm test

  deploy:
    name: Deploy
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: jdx/mise-action@v2

      - name: Install Dependencies
        run: bun install

      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Configure Infrastructure
        run: |
          pulumi stack select radiosilence/jaritanet/main
          pulumi config set --path jaritanet:cloudflare.accountId "$CLOUDFLARE_ACCOUNT_ID"
        working-directory: packages/infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Infrastructure
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: radiosilence/jaritanet/main
          work-dir: packages/infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Configure Kubernetes
        run: |
          pulumi stack select radiosilence/jaritanet-k8s/main
          pulumi config set --path jaritanet-k8s:cloudflare.accountId "$CLOUDFLARE_ACCOUNT_ID"
          pulumi config set --path jaritanet-k8s:services.navidrome.hostname "$NAVIDROME_HOSTNAME"
          pulumi config set --path jaritanet-k8s:services.files.hostname "$FILES_HOSTNAME"
          pulumi config set --path jaritanet-k8s:services.blit.hostname "$BLIT_HOSTNAME"
        working-directory: packages/k8s
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NAVIDROME_HOSTNAME: ${{ secrets.NAVIDROME_HOSTNAME }}
          FILES_HOSTNAME: ${{ secrets.FILES_HOSTNAME }}
          BLIT_HOSTNAME: ${{ secrets.BLIT_HOSTNAME }}

      - name: Deploy Kubernetes
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: radiosilence/jaritanet-k8s/main
          work-dir: packages/k8s
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          KUBE_HOST: ${{ secrets.KUBE_HOST }}
          KUBE_API_PORT: ${{ secrets.KUBE_API_PORT }}
          KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}

      - name: Configure Routes
        run: |
          pulumi stack select radiosilence/jaritanet-routes/main
          pulumi config set --path jaritanet-routes:cloudflare.accountId "$CLOUDFLARE_ACCOUNT_ID"
        working-directory: packages/routes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy Routes
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: radiosilence/jaritanet-routes/main
          work-dir: packages/routes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
